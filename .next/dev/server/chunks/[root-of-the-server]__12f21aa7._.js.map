{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/kirti.krishnan/Desktop/Projects/RTAA/rtaa/app/api/ingest/s3-index/route.ts"],"sourcesContent":["/**\n * S3 Index API - Returns manifest of available transcript chunks.\n * In dev mode: lists local files from ./data/${callId}/\n * In prod mode: generates presigned URLs from S3\n */\n\nimport { NextResponse } from 'next/server';\nimport { readdir } from 'fs/promises';\nimport { join } from 'path';\n\ninterface ManifestEntry {\n  url: string;\n  seq: number;\n}\n\nexport async function GET(req: Request) {\n  try {\n    const url = new URL(req.url);\n    const callId = url.searchParams.get('callId');\n\n    if (!callId) {\n      return NextResponse.json(\n        { ok: false, error: 'Missing callId parameter' },\n        { status: 400 }\n      );\n    }\n\n    console.info(`[s3-index] Fetching manifest for callId=${callId}`);\n\n    // Development mode: read from local filesystem\n    if (process.env.NODE_ENV === 'development') {\n      const manifest = await getDevManifest(callId);\n      return NextResponse.json({ ok: true, manifest });\n    }\n\n    // Production mode: generate presigned URLs from S3\n    const s3Bucket = process.env.S3_BUCKET;\n    const s3IngestPrefix = process.env.S3_INGEST_PREFIX;\n    const s3Region = process.env.S3_REGION;\n\n    if (!s3Bucket || !s3IngestPrefix || !s3Region) {\n      console.warn('[s3-index] S3 configuration missing in production');\n      return NextResponse.json(\n        {\n          ok: false,\n          error: 'S3 configuration not available. Set S3_BUCKET, S3_INGEST_PREFIX, S3_REGION',\n          manifest: [],\n        },\n        { status: 503 }\n      );\n    }\n\n    // TODO: Implement S3 presigned URL generation\n    // For now, return placeholder\n    console.warn('[s3-index] S3 presigned URL generation not yet implemented');\n    return NextResponse.json({\n      ok: false,\n      error: 'S3 presigned URL generation not yet implemented',\n      manifest: [],\n    });\n  } catch (err: any) {\n    console.error('[s3-index] Error:', err);\n    return NextResponse.json(\n      { ok: false, error: err.message || String(err) },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * Get manifest from local filesystem in development mode.\n */\nasync function getDevManifest(callId: string): Promise<ManifestEntry[]> {\n  const dataDir = join(process.cwd(), 'data', callId);\n\n  try {\n    const files = await readdir(dataDir);\n\n    // Filter chunk files and extract seq numbers\n    const manifest: ManifestEntry[] = files\n      .filter((f) => /^chunk-\\d+\\.json$/.test(f))\n      .map((f) => {\n        const match = f.match(/^chunk-(\\d+)\\.json$/);\n        const seq = parseInt(match![1], 10);\n        return {\n          url: `/data/${callId}/${f}`,\n          seq,\n        };\n      })\n      .sort((a, b) => a.seq - b.seq);\n\n    console.info(`[s3-index] Found ${manifest.length} chunks in ${dataDir}`);\n    return manifest;\n  } catch (err: any) {\n    if (err.code === 'ENOENT') {\n      console.warn(`[s3-index] Directory not found: ${dataDir}`);\n      return [];\n    }\n    throw err;\n  }\n}\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;AAED;AACA;AACA;;;;AAOO,eAAe,IAAI,GAAY;IACpC,IAAI;QACF,MAAM,MAAM,IAAI,IAAI,IAAI,GAAG;QAC3B,MAAM,SAAS,IAAI,YAAY,CAAC,GAAG,CAAC;QAEpC,IAAI,CAAC,QAAQ;YACX,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,IAAI;gBAAO,OAAO;YAA2B,GAC/C;gBAAE,QAAQ;YAAI;QAElB;QAEA,QAAQ,IAAI,CAAC,CAAC,wCAAwC,EAAE,QAAQ;QAEhE,+CAA+C;QAC/C,wCAA4C;YAC1C,MAAM,WAAW,MAAM,eAAe;YACtC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAM;YAAS;QAChD;;;QAEA,mDAAmD;QACnD,MAAM;QACN,MAAM;QACN,MAAM;IAsBR,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,qBAAqB;QACnC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,IAAI;YAAO,OAAO,IAAI,OAAO,IAAI,OAAO;QAAK,GAC/C;YAAE,QAAQ;QAAI;IAElB;AACF;AAEA;;CAEC,GACD,eAAe,eAAe,MAAc;IAC1C,MAAM,UAAU,IAAA,yGAAI,EAAC,QAAQ,GAAG,IAAI,QAAQ;IAE5C,IAAI;QACF,MAAM,QAAQ,MAAM,IAAA,gIAAO,EAAC;QAE5B,6CAA6C;QAC7C,MAAM,WAA4B,MAC/B,MAAM,CAAC,CAAC,IAAM,oBAAoB,IAAI,CAAC,IACvC,GAAG,CAAC,CAAC;YACJ,MAAM,QAAQ,EAAE,KAAK,CAAC;YACtB,MAAM,MAAM,SAAS,KAAM,CAAC,EAAE,EAAE;YAChC,OAAO;gBACL,KAAK,CAAC,MAAM,EAAE,OAAO,CAAC,EAAE,GAAG;gBAC3B;YACF;QACF,GACC,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,GAAG,GAAG,EAAE,GAAG;QAE/B,QAAQ,IAAI,CAAC,CAAC,iBAAiB,EAAE,SAAS,MAAM,CAAC,WAAW,EAAE,SAAS;QACvE,OAAO;IACT,EAAE,OAAO,KAAU;QACjB,IAAI,IAAI,IAAI,KAAK,UAAU;YACzB,QAAQ,IAAI,CAAC,CAAC,gCAAgC,EAAE,SAAS;YACzD,OAAO,EAAE;QACX;QACA,MAAM;IACR;AACF","debugId":null}}]
}