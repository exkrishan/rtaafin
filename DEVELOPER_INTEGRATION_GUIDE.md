# Developer Integration Guide - External ASR to Real-Time Agent Assist

## üéØ Overview

This guide is for integrating your **Azure Speech SDK WebSocket service** with our **Real-Time Agent Assist Platform**.

**What you need to do**: Send transcripts in real-time to our HTTP API endpoint as they are generated by your ASR service.

**What we handle**: Everything else - storage, intent detection, knowledge base suggestions, UI display, and disposition generation.

---

## üì° API Endpoint

### Production URL
```
POST https://frontend-8jdd.onrender.com/api/transcripts/receive
```

### Authentication
**None required** - Open endpoint for your ASR service

### Rate Limits
- No explicit rate limits
- Designed to handle real-time transcript streaming (100+ requests/second per call)

---

## üìã Request Format

### HTTP Headers
```http
POST /api/transcripts/receive HTTP/1.1
Host: frontend-8jdd.onrender.com
Content-Type: application/json
```

### Request Body (JSON)

```json
{
  "callId": "string",           // REQUIRED: Unique identifier for the call
  "transcript": "string",       // REQUIRED: The transcribed text
  "session_id": "string|null",  // OPTIONAL: Your internal session ID (can be null)
  "asr_service": "string",      // REQUIRED: Service name (e.g., "Azure", "Google", "AWS")
  "timestamp": "string",        // REQUIRED: ISO 8601 timestamp
  "isFinal": boolean            // REQUIRED: true = final, false = partial/interim
}
```

### Field Descriptions

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| `callId` | string | ‚úÖ Yes | Unique call identifier. Use the same ID for all transcripts from the same call. | `"call-abc123"` |
| `transcript` | string | ‚úÖ Yes | The transcribed text. Can be empty string for silence detection. | `"Hello, how can I help you?"` |
| `session_id` | string or null | ‚ùå No | Your internal session/connection ID. Set to `null` if not used. | `"session-xyz789"` or `null` |
| `asr_service` | string | ‚úÖ Yes | Name of your ASR service for tracking purposes. | `"Azure"` |
| `timestamp` | string | ‚úÖ Yes | When the transcript was generated (ISO 8601 format). | `"2024-11-28T12:34:56.789Z"` |
| `isFinal` | boolean | ‚úÖ Yes | `true` = final/committed transcript<br>`false` = partial/interim result | `true` or `false` |

### Important Notes

1. **callId Consistency**: Use the same `callId` for all transcripts from a single call session
2. **Timestamp Format**: Must be valid ISO 8601 (UTC recommended): `YYYY-MM-DDTHH:mm:ss.sssZ`
3. **isFinal Flag**: 
   - `false` = Partial/interim results (can change)
   - `true` = Final/committed results (won't change)
4. **Transcript Text**: Send even if empty (useful for silence detection)

---

## ‚úÖ Response Format

### Success Response (200 OK)

```json
{
  "ok": true,
  "callId": "call-abc123",
  "seq": 1,
  "message": "Transcript received and processing"
}
```

| Field | Description |
|-------|-------------|
| `ok` | Always `true` for successful requests |
| `callId` | Echo of your callId |
| `seq` | Auto-generated sequence number for ordering |
| `message` | Confirmation message |

**Response Time**: < 100ms (fire-and-forget processing)

### Error Responses

#### 400 Bad Request - Missing Required Field
```json
{
  "ok": false,
  "error": "callId is required"
}
```

Possible error messages:
- `"callId is required"`
- `"transcript is required"`
- `"timestamp is required"`
- `"isFinal is required"`

#### 500 Internal Server Error
```json
{
  "ok": false,
  "error": "Internal server error"
}
```

---

## üîÑ Integration Flow

### Recommended Workflow

```
1. Call Starts
   ‚Üì
2. Your ASR WebSocket opens connection
   ‚Üì
3. Audio chunks arrive
   ‚Üì
4. Azure Speech SDK generates transcripts (partial and final)
   ‚Üì
5. FOR EACH TRANSCRIPT:
   ‚Üí POST to /api/transcripts/receive
   ‚Üì
6. Continue until call ends
   ‚Üì
7. Close WebSocket connection
```

### When to Send Transcripts

**Send BOTH partial and final transcripts** for the best user experience:

- ‚úÖ **Partial Results** (`isFinal: false`): Send as Azure generates them for real-time display
- ‚úÖ **Final Results** (`isFinal: true`): Send when Azure commits the final version

**Example sequence for one utterance:**
```javascript
// Partial 1
POST { callId: "call-123", transcript: "Hello", isFinal: false, ... }

// Partial 2 (updated)
POST { callId: "call-123", transcript: "Hello how", isFinal: false, ... }

// Final
POST { callId: "call-123", transcript: "Hello, how can I help you?", isFinal: true, ... }
```

---

## üíª Code Examples

### Example 1: Node.js with Fetch

```javascript
async function sendTranscript(callId, transcriptText, isFinal) {
  const response = await fetch('https://frontend-8jdd.onrender.com/api/transcripts/receive', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      callId: callId,
      transcript: transcriptText,
      session_id: null,
      asr_service: 'Azure',
      timestamp: new Date().toISOString(),
      isFinal: isFinal
    })
  });

  if (!response.ok) {
    const error = await response.json();
    console.error('Failed to send transcript:', error);
    throw new Error(error.error || 'Unknown error');
  }

  const result = await response.json();
  console.log('Transcript sent successfully:', result);
  return result;
}

// Usage
await sendTranscript('call-abc123', 'Hello, how can I help you?', true);
```

### Example 2: Python with Requests

```python
import requests
from datetime import datetime

def send_transcript(call_id, transcript_text, is_final):
    url = 'https://frontend-8jdd.onrender.com/api/transcripts/receive'
    
    payload = {
        'callId': call_id,
        'transcript': transcript_text,
        'session_id': None,
        'asr_service': 'Azure',
        'timestamp': datetime.utcnow().isoformat() + 'Z',
        'isFinal': is_final
    }
    
    response = requests.post(url, json=payload)
    
    if response.status_code != 200:
        print(f'Error: {response.json()}')
        raise Exception(f'HTTP {response.status_code}')
    
    result = response.json()
    print(f'Transcript sent successfully: {result}')
    return result

# Usage
send_transcript('call-abc123', 'Hello, how can I help you?', True)
```

### Example 3: cURL (Testing)

```bash
curl -X POST https://frontend-8jdd.onrender.com/api/transcripts/receive \
  -H "Content-Type: application/json" \
  -d '{
    "callId": "test-call-001",
    "transcript": "Hello, I need help with my energy bill",
    "session_id": null,
    "asr_service": "Azure",
    "timestamp": "2024-11-28T12:00:00Z",
    "isFinal": true
  }'
```

**Expected response:**
```json
{"ok":true,"callId":"test-call-001","seq":1,"message":"Transcript received and processing"}
```

---

## üß™ Testing Guide

### Step 1: Test Single Transcript

```bash
# Send one transcript
curl -X POST https://frontend-8jdd.onrender.com/api/transcripts/receive \
  -H "Content-Type: application/json" \
  -d '{
    "callId": "test-'$(date +%s)'",
    "transcript": "This is a test transcript",
    "session_id": null,
    "asr_service": "Azure",
    "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
    "isFinal": true
  }'
```

‚úÖ **Success criteria**: HTTP 200 response with `"ok": true`

### Step 2: Test Multiple Transcripts (Same Call)

```bash
# Use the same callId for all transcripts
CALL_ID="test-multi-$(date +%s)"

# Transcript 1
curl -X POST https://frontend-8jdd.onrender.com/api/transcripts/receive \
  -H "Content-Type: application/json" \
  -d '{
    "callId": "'$CALL_ID'",
    "transcript": "Hello, I need help",
    "session_id": null,
    "asr_service": "Azure",
    "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
    "isFinal": false
  }'

sleep 1

# Transcript 2
curl -X POST https://frontend-8jdd.onrender.com/api/transcripts/receive \
  -H "Content-Type: application/json" \
  -d '{
    "callId": "'$CALL_ID'",
    "transcript": "with my energy billing account",
    "session_id": null,
    "asr_service": "Azure",
    "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
    "isFinal": true
  }'
```

### Step 3: Verify in UI

1. Open: `https://frontend-8jdd.onrender.com/live`
2. The UI will auto-detect active calls
3. You should see your test transcripts appear in real-time

---

## üé¨ What Happens After You Send a Transcript?

Our platform automatically processes each transcript:

### 1. **Storage** (Immediate)
- Transcript saved to Supabase database
- Assigned a sequence number for ordering
- Timestamped and tagged with call metadata

### 2. **Intent Detection** (2-3 seconds)
- LLM (Google Gemini) analyzes the transcript
- Identifies customer intent (e.g., "billing_inquiry", "service_request")
- Confidence score calculated

### 3. **Knowledge Base Surfacing** (2-3 seconds)
- Relevant KB articles retrieved based on detected intent
- Articles ranked by relevance
- Top 3-5 suggestions surfaced to agent

### 4. **Real-Time UI Update** (< 1 second)
- Transcript appears in agent's UI
- Intent badge displayed
- KB suggestions shown in sidebar
- Auto-scroll to latest message

### 5. **Disposition Generation** (On Call End)
- Full call transcript analyzed
- AI-generated summary (issue, resolution, next steps)
- Suggested disposition codes
- Agent can edit and submit

---

## üö® Error Handling Best Practices

### Retry Logic

```javascript
async function sendTranscriptWithRetry(callId, transcript, isFinal, maxRetries = 3) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const response = await fetch('https://frontend-8jdd.onrender.com/api/transcripts/receive', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          callId,
          transcript,
          session_id: null,
          asr_service: 'Azure',
          timestamp: new Date().toISOString(),
          isFinal
        }),
        timeout: 5000 // 5 second timeout
      });

      if (response.ok) {
        return await response.json();
      }

      // Don't retry on 4xx errors (bad request)
      if (response.status >= 400 && response.status < 500) {
        const error = await response.json();
        console.error('Client error, not retrying:', error);
        throw new Error(error.error);
      }

      // Retry on 5xx errors
      console.warn(`Attempt ${attempt} failed with status ${response.status}`);
      if (attempt < maxRetries) {
        await sleep(1000 * attempt); // Exponential backoff
      }
    } catch (err) {
      console.error(`Attempt ${attempt} failed:`, err);
      if (attempt === maxRetries) {
        throw err;
      }
      await sleep(1000 * attempt);
    }
  }
}
```

### Handling Network Issues

```javascript
// Log failed transcripts for debugging
const failedTranscripts = [];

async function sendTranscriptSafe(callId, transcript, isFinal) {
  try {
    await sendTranscriptWithRetry(callId, transcript, isFinal);
  } catch (err) {
    console.error('Failed to send transcript after retries:', err);
    
    // Store for later analysis
    failedTranscripts.push({
      callId,
      transcript,
      isFinal,
      timestamp: new Date().toISOString(),
      error: err.message
    });
    
    // Don't throw - continue processing other transcripts
  }
}
```

---

## üìä Performance Expectations

| Metric | Target | Notes |
|--------|--------|-------|
| API Response Time | < 100ms | Fire-and-forget processing |
| Transcript Display in UI | < 2s | From POST to UI update |
| Intent Detection | 2-3s | LLM processing time |
| KB Article Surfacing | 2-3s | Search and ranking |
| API Uptime | 99.9% | Hosted on Render |

---

## üîê Security Notes

1. **No Authentication**: Open endpoint (for POC)
   - For production, we can add API key authentication if needed
   
2. **HTTPS Only**: All traffic encrypted in transit

3. **Data Privacy**: 
   - Transcripts stored in Supabase (encrypted at rest)
   - Retained for call analysis and quality assurance
   - Can configure retention policies

---

## üìû Integration Checklist

Before going live, verify:

- [ ] Your ASR service can make HTTP POST requests
- [ ] callId is unique and consistent per call session
- [ ] Timestamps are in ISO 8601 format (UTC)
- [ ] Both partial and final transcripts are sent
- [ ] Error handling and retry logic implemented
- [ ] Tested with sample calls (min. 5 calls)
- [ ] Verified transcripts appear in UI: https://frontend-8jdd.onrender.com/live
- [ ] Confirmed intent detection works
- [ ] Confirmed KB articles surface correctly

---

## üêõ Troubleshooting

### Issue: 400 Bad Request - "callId is required"

**Cause**: Missing or invalid field in request body

**Fix**: Ensure all required fields are present:
```javascript
{
  callId: "‚úÖ present",
  transcript: "‚úÖ present",
  timestamp: "‚úÖ present",
  isFinal: true, // ‚úÖ boolean
  asr_service: "Azure",
  session_id: null
}
```

### Issue: 500 Internal Server Error

**Cause**: Server-side processing error

**Fix**: 
1. Check request format matches documentation exactly
2. Retry the request (may be transient)
3. Contact support with callId and timestamp

### Issue: Transcripts not appearing in UI

**Possible causes**:
1. callId mismatch between transcripts
2. UI not subscribed to the correct callId
3. Transcript processing delay

**Debug steps**:
1. Verify API returns 200 OK
2. Check UI console for errors
3. Refresh the UI page
4. Wait 5-10 seconds for processing

### Issue: Intent not detected

**Possible causes**:
1. Transcript too short (< 5 characters)
2. LLM API rate limit or error
3. Generic/unclear transcript text

**Expected behavior**:
- Intent detected after 10-15 words of meaningful conversation
- May show "unknown" for very short or unclear transcripts

---

## üìß Support

For integration support:
- **Technical Issues**: Check application logs and verify request format
- **API Errors**: Include callId, timestamp, and full error response
- **Performance Issues**: Provide timing details and callId for investigation

---

## üöÄ Quick Start Commands

```bash
# Test basic connectivity
curl https://frontend-8jdd.onrender.com/api/transcripts/receive

# Send test transcript
curl -X POST https://frontend-8jdd.onrender.com/api/transcripts/receive \
  -H "Content-Type: application/json" \
  -d '{
    "callId": "quickstart-test",
    "transcript": "Testing API integration",
    "session_id": null,
    "asr_service": "Azure",
    "timestamp": "2024-11-28T12:00:00Z",
    "isFinal": true
  }'

# View UI
open https://frontend-8jdd.onrender.com/live
```

---

**Document Version**: 1.0  
**Last Updated**: November 28, 2024  
**API Status**: ‚úÖ Production Ready

