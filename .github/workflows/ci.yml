name: CI

# Trigger on push and pull requests to main, develop, and feature branches
on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop
      - 'feature/**'

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest

    # Environment variables from GitHub Secrets
    # Required secrets must be set in repository settings:
    # Settings > Secrets and variables > Actions > New repository secret
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
      LLM_API_KEY: ${{ secrets.LLM_API_KEY }}

    steps:
      # 1. Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Node.js using .nvmrc
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      # 3. Print Node version for debugging
      - name: Print Node version
        run: |
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"

      - name: Ensure secure TLS not enabled
        run: |
          if [ "${{ env.ALLOW_INSECURE_TLS }}" = "true" ]; then
            echo "ERROR: ALLOW_INSECURE_TLS must not be set in CI (dangerous)."
            exit 1
          fi

      # 4. Validate required secrets are present
      - name: Validate required secrets
        run: |
          echo "ğŸ” Validating required environment variables..."
          MISSING_SECRETS=()

          if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ]; then
            MISSING_SECRETS+=("NEXT_PUBLIC_SUPABASE_URL")
          fi

          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            MISSING_SECRETS+=("SUPABASE_SERVICE_ROLE_KEY")
          fi

          if [ -z "$ADMIN_KEY" ]; then
            MISSING_SECRETS+=("ADMIN_KEY")
          fi

          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ Error: Missing required secrets in GitHub repository settings:"
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "   - $secret"
            done
            echo ""
            echo "ğŸ’¡ To fix this:"
            echo "   1. Go to: Settings > Secrets and variables > Actions"
            echo "   2. Click 'New repository secret'"
            echo "   3. Add the missing secrets listed above"
            echo ""
            echo "ğŸ“– See CI.md for detailed instructions"
            exit 1
          fi

          echo "âœ… All required secrets are present"

      # 5. Install dependencies
      - name: Install dependencies
        run: npm ci

      # 6. Run build (to catch TypeScript errors)
      - name: Build project
        run: npm run build
        continue-on-error: false

      # 7. Run configuration tests
      - name: Run configuration tests
        run: |
          echo "ğŸ§ª Running configuration tests..."
          npx tsx tests/config.test.ts
        continue-on-error: false

      # 8. Run quick KB test (smoke test)
      - name: Run KB adapter smoke test
        run: |
          echo "ğŸ” Running KB adapter smoke test..."
          node scripts/env-bootstrap.mjs scripts/quick-kb-test.ts --query "test" --max 3
        continue-on-error: false

      # 9. Report success
      - name: Report success
        if: success()
        run: |
          echo "âœ… All tests passed!"
          echo "ğŸ‰ CI pipeline completed successfully"
